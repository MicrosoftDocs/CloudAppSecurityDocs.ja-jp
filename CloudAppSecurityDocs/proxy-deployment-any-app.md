---
title: 任意のアプリに対して Cloud App Security のアプリの条件付きアクセス制御を展開する
description: この記事では、任意のアプリに対して Microsoft Cloud App Security のアプリの条件付きアクセス制御のリバース プロキシ機能を展開する方法について説明します。
keywords: ''
author: shsagir
ms.author: shsagir
manager: shsagir
ms.date: 03/31/2020
ms.topic: conceptual
ms.collection: M365-security-compliance
ms.prod: ''
ms.service: cloud-app-security
ms.technology: ''
ms.suite: ems
ms.openlocfilehash: ddbcbbe72c83f926b8307904a9d5e2bb2731dcba
ms.sourcegitcommit: 5822fcdb1433a6a26195692b05aed160bc339656
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/02/2020
ms.locfileid: "84275797"
---
# <a name="onboard-and-deploy-conditional-access-app-control-for-any-app"></a>任意のアプリに対するアプリの条件付きアクセス制御のオンボードと展開

*適用対象:Microsoft Cloud App Security*

Microsoft Cloud App Security のセッション制御は、任意の Web アプリと連動するように構成できます。 この記事では、セッション制御を使用した Azure Active Directory (Azure AD) アプリケーション プロキシを介してホストされるカスタムの基幹業務アプリ、おすすめ以外の SaaS アプリ、およびオンプレミスのアプリをオンボードして展開する方法について説明します。

Cloud App Security でおすすめされている、すぐに使用できるアプリの一覧については、[Cloud App Security のアプリの条件付きアクセス制御を使用したアプリの保護](proxy-intro-aad.md#featured-apps)に関する記事をご覧ください。

## <a name="prerequisites"></a>[前提条件]

- アプリの条件付きアクセス制御を使用するには、お客様の組織が次のライセンスを持っている必要があります。

  - [Azure Active Directory (Azure AD) Premium P1](https://docs.microsoft.com/azure/active-directory/license-users-groups) 以上、またはお使いの ID プロバイダー (IdP) ソリューションから要求されるライセンス
  - Microsoft Cloud App Security

- アプリはシングル サインオンを使用して構成する必要があります
- アプリで、次のいずれかの認証プロトコルを使用する必要があります。

    |IdP|プロトコル|
    |---|---|
    |Azure AD|SAML 2.0 または OpenID Connect|
    |その他|SAML 2.0|

## <a name="to-deploy-any-app"></a>任意のアプリを展開するには

次の手順に従って、Cloud App Security のアプリの条件付きアクセス制御で制御されるように、任意のアプリを構成します。

**手順 1: [Cloud App Security と連動するように IdP を構成する](#conf-idp)**

**手順 2: [アプリを展開するユーザーを構成する](#conf-users)**

**手順 3: [展開するアプリを構成する](#conf-app)**

**手順 4: [アプリが正常に動作していることを確認する](#verify-app)**

**手順 5: [組織でアプリを使用できるようにする](#enable-app)**

**手順 6: [Azure AD ポリシーを更新する](#update-azure-ad)**

> [!NOTE]
> Azure AD アプリに対してアプリの条件付きアクセス制御を展開するには、有効な [Azure Active Directory Premium P1 以上のライセンス](https://docs.microsoft.com/azure/active-directory/license-users-groups)と、Cloud App Security ライセンスが必要です。

## <a name="step-1--configure-your-idp-to-work-with-cloud-app-security"></a>手順 1:Cloud App Security と連動するように IdP を構成する<a name="conf-idp"></a><a name="conf-azure-ad"></a>

### <a name="configure-integration-with-azure-ad"></a>Azure AD との統合を構成する

次の手順に従って、アプリ セッションを Cloud App Security にルーティングする Azure AD 条件付きアクセス ポリシーを作成します。 その他の IdP ソリューションについては、「[その他の IdP ソリューションとの統合を構成する](#configure-integration-with-other-idp-solutions)」をご覧ください。

1. Azure AD で、 **[セキュリティ]**  >  **[条件付きアクセス]** の順に移動します。

1. **[条件付きアクセス]** ペインの上部にあるツール バーで、 **[新しいポリシー]** をクリックします。

1. **[新規]** ペインの **[名前]** テキストボックスに、ポリシー名を入力します。

1. **[割り当て]** の下で、 **[ユーザーとグループ]** をクリックし、アプリのオンボード (最初のサインオンと確認) を行うユーザーを割り当ててから、 **[完了]** をクリックします。

1. **[割り当て]** の下で、 **[クラウド アプリ]** をクリックし、アプリの条件付きアクセス制御を使用して制御するアプリを割り当ててから、 **[完了]** をクリックします。

1. **[アクセス制御]** の下で **[セッション]** をクリックし、 **[アプリの条件付きアクセス制御を使う]** を選択して、組み込みのポリシー ( **[監視のみ]** または **[ダウンロードを禁止する]** ) または **[カスタム ポリシーを使用する]** を選択し、Cloud App Security の高度なポリシーを設定します。その後、 **[選択]** をクリックします。

    ![Azure AD 条件付きアクセス](media/azure-ad-caac-policy.png)

1. 必要に応じて、条件の追加と制御の許可を行います。

1. **[ポリシーを有効にする]** を **[オン]** に設定して、 **[作成]** をクリックします。

### <a name="configure-integration-with-other-idp-solutions"></a>その他の IdP ソリューションとの統合を構成する

次の手順に従って、他の IdP ソリューションから Cloud App Security にアプリ セッションをルーティングします。 Azure AD については、「[Azure AD との統合を構成する](#configure-integration-with-azure-ad)」をご覧ください。

1. Cloud App Security で、 **[調査]**  >  **[接続アプリ]**  >  **[アプリの条件付きアクセス制御アプリ]** の順に移動します。

1. プラス記号をクリックし、ポップアップで展開するアプリを選択してから、 **[ウィザード起動]** をクリックします。
1. **[アプリ情報]** ページで、アプリのシングル サインオン構成のページからの情報を使用してフォームに入力し、 **[次へ]** をクリックします。
    - お使いの IdP から、選択したアプリのシングル サインオンのメタデータ ファイルが提供されている場合は、 **[アプリからのメタデータ ファイルをアップロードする]** を選択してメタデータ ファイルをアップロードします。
    - または、 **[データを手動で入力する]** を選択して、次の情報を指定します。
        - **Assertion Consumer Service URL**
        - アプリで SAML 証明書が提供されている場合は、 **[<アプリ名> の SAML 証明書を使用する]** を選択して、証明書ファイルをアップロードします。

    ![アプリ情報ページを示すスクリーンショット](media/proxy-deploy-add-idp-app-info.png)

1. **[ID プロバイダー]** ページで、表示されている手順に従って IdP のポータルで新しいアプリケーションを設定した後、 **[次へ]** をクリックします。
    1. IdP のポータルに移動して、新しいカスタム SAML アプリを作成します。
    1. 既存の `<app_name>` アプリのシングル サインオン構成を、新しいカスタム アプリにコピーします。
    1. 新しいカスタム アプリにユーザーを割り当てます。
    1. アプリのシングル サインオン構成の情報をコピーします。次の手順で必要になります。

    ![ID プロバイダーの情報を収集するページを示すスクリーンショット](media/proxy-deploy-add-idp-get-conf.png)

    > [!NOTE]
    > これらの手順は、使用する ID プロバイダーによって多少異なる場合があります。 この手順は、次の理由で推奨されます。
    >
    > - 一部の ID プロバイダーでは、ギャラリー アプリの SAML 属性や URL プロパティを変更できません
    > - カスタム アプリを構成すると、組織の既存の動作を変更することなく、アクセスおよびセッション制御を使用してこのアプリケーションをテストできます。

1. 次のページで、アプリのシングル サインオン構成のページからの情報を使用してフォームに入力し、 **[次へ]** をクリックします。
    - お使いの IdP から、選択したアプリのシングル サインオンのメタデータ ファイルが提供されている場合は、 **[アプリからのメタデータ ファイルをアップロードする]** を選択してメタデータ ファイルをアップロードします。
    - または、 **[データを手動で入力する]** を選択して、次の情報を指定します。
        - **Assertion Consumer Service URL**
        - アプリで SAML 証明書が提供されている場合は、 **[<アプリ名> の SAML 証明書を使用する]** を選択して、証明書ファイルをアップロードします。

    ![ID プロバイダーの情報を入力するページを示すスクリーンショット](media/proxy-deploy-add-idp-enter-conf.png)

1. 次のページで、以下の情報をコピーしてから、 **[次へ]** をクリックします。 次の手順でこの情報が必要になります。

    - シングル サインオンの URL
    - 属性と値

    ![ID プロバイダーの SAML 情報を収集するページを示すスクリーンショット](media/proxy-deploy-add-idp-ext-conf.png)

1. IdP のポータルで、次の操作を行います。
    > [!NOTE]
    > この設定は、IdP ポータルのカスタム アプリの設定ページによくあります

    1. シングル サインオンの URL フィールドに、前にメモしておいたシングル サインオンの URL を入力します。
        > [!NOTE]
        > プロバイダーによっては、シングル サインオンの URL が "*応答 URL*" として参照される場合があります。
    1. 前にメモしておいた属性と値を、アプリのプロパティに追加します。
        > [!NOTE]
        >
        > - プロバイダーによっては、これらが "*ユーザー属性*" または "*要求*" として参照される場合があります。
        > - 新しい SAML アプリを作成する場合、Okta ID プロバイダーでは属性が 1024 文字に制限されます。 この制限を緩和するには、まず、関連する属性なしでアプリを作成します。 アプリの作成後に編集して、関連する属性を追加します。
    1. 名前識別子がメール アドレスの形式であることを確認します。
    1. 設定を保存します。
1. **[アプリの変更]** ページで、次の操作を行って、 **[次へ]** をクリックします。 次の手順でこの情報が必要になります。

    - シングル サインオンの URL をコピーします
    - Cloud App Security の SAML 証明書をダウンロードします

    ![Cloud App Security の SAML 情報を収集するページを示すスクリーンショット](media/proxy-deploy-add-idp-app-changes.png)

1. アプリのポータルの、シングル サインオンの設定で、次の操作を行います。
    1. [推奨] 現在の設定のバックアップを作成します。
    1. シングル サインオンの URL フィールドに、前にメモしておいたシングル サインオンの URL を入力します。
    1. 前にメモしておいた Cloud App Security の SAML 証明書をアップロードします。
    > [!NOTE]
    > 設定を保存すると、このアプリに関連付けられたすべてのログイン要求が、アプリの条件付きアクセス制御経由でルーティングされます。

## <a name="step-2-configure-the-users-that-will-deploy-the-app"></a>手順 2:アプリを展開するユーザーを構成する<a name="conf-users"></a>

1. Cloud App Security のメニュー バーで設定の歯車 ![設定アイコン](media/settings-icon.png "設定アイコン") をクリックし、 **[設定]** を選択します。

1. **[アプリの条件付きアクセス制御]** の下で、 **[アプリのオンボードとメンテナンス]** を選択します。

1. アプリをオンボードするユーザーのユーザー プリンシパル名または電子メールを入力し、 **[保存]** をクリックします。

    ![アプリのオンボードとメンテナンスの設定のスクリーンショット。](media/app-onboarding-settings.png)

## <a name="step-3-configure-the-app-that-you-are-deploying"></a>手順 3:展開するアプリを構成する<a name="conf-app"></a>

展開するアプリにアクセスします。 表示されるページは、アプリが認識されているかどうかによって異なります。 以下のいずれかを実行します。

| アプリ状況 | [説明] | 手順 |
| --- | --- | --- |
| 認識されていない | アプリが認識されていない画面が表示され、アプリを構成するように求められます。 | 1.[アプリをアプリの条件付きアクセス制御に追加します](#add-app)。<br /> 2.[アプリのドメインを追加](#add-domains)し、アプリに戻ってページを更新します。<br /> 3.[アプリの証明書をインストールします](#install-certs)。 |
| 認識されている | オンボード ページが表示され、アプリの構成プロセスを続行するように求められます。 | - [アプリの証明書をインストールします](#install-certs)。 <br /><br /> **注:** アプリが正常に機能するために必要なすべてのドメインを使用してアプリが構成されていることを確認します。 追加のドメインを構成するには、[アプリのドメインの追加](#add-domains)に進んでから、アプリのページに戻ります。 |

### <a name="to-add-a-new-app"></a>新しいアプリを追加するには<a name="add-app"></a>

1. メニュー バーで設定の歯車 ![設定アイコン](media/settings-icon.png "設定アイコン") をクリックし、 **[アプリの条件付きアクセス制御]** を選択します。

1. **[View new apps]\(新しいアプリの表示\)** をクリックします。

    ![[アプリの条件付きアクセス制御] の [View new apps]\(新しいアプリの表示\)](media/caac-view-apps.png)

1. 開いた画面に、新しいアプリの一覧が表示されます。 オンボードするアプリごとに、 **+** 記号をクリックして、 **[追加]** をクリックします。

    > [!NOTE]
    > アプリが Cloud App Security のアプリ カタログに表示されない場合は、不明なアプリの下のダイアログに、ログイン URL と共に表示されます。 これらのアプリの + 記号をクリックすると、カスタム アプリとしてアプリケーションをオンボードできます。

    ![[アプリの条件付きアクセス制御] の検出された Azure AD アプリ](media/caac-discovered-aad-apps.png)

### <a name="to-add-domains-for-an-app"></a>アプリのドメインを追加するには<a name="add-domains"></a>

適切なドメインをアプリに関連付けることにより、Cloud App Security によるポリシーと監査アクティビティの適用が可能になります。

たとえば、関連付けられているドメインのファイルのダウンロードをブロックするポリシーを構成した場合、アプリによるそのドメインからのファイルのダウンロードはブロックされます。 ただし、アプリに関連付けられていないドメインからの、アプリによるファイルのダウンロードはブロックされず、その操作はアクティビティ ログで監査されません。
> [!NOTE]
> Cloud App Security では、シームレスなユーザー エクスペリエンスを保証するために、アプリに関連付けられていないドメインにもサフィックスが追加されます。

1. アプリ内の Cloud App Security 管理ツール バーで、 **[検出されたドメイン]** をクリックします。
    > [!NOTE]
    > 管理ツール バーは、アプリをオンボードまたはメンテナンスするアクセス許可を持つユーザーにのみ表示されます。
1. [検出されたドメイン] パネルで、ドメイン名をメモしておくか、一覧を .csv ファイルとしてエクスポートします。
    > [!NOTE]
    > パネルには、アプリで関連付けられていない検出されたドメインの一覧が表示されます。 ドメイン名は完全修飾です。
1. Cloud App Security に移動し、メニュー バーで設定の歯車 ![設定アイコン](media/settings-icon.png "設定アイコン") をクリックし、 **[アプリの条件付きアクセス制御]** を選択します。
1. アプリの一覧で、展開するアプリが表示されている行の末尾の 3 つのドットを選択し、 **[アプリの詳細]** の下の **[編集]** を選択します。
    > [!TIP]
    > アプリで構成されているドメインの一覧を表示するには、 **[アプリ ドメインの表示]** をクリックします。
1. **[ユーザー定義のドメイン]** で、このアプリに関連付けるすべてのドメインを入力し、 **[保存]** をクリックします。
    > [!NOTE]
    > ワイルドカード文字「*」を、任意の文字のプレースホルダーとして使用できます。 ドメインを追加するときに、特定のドメイン (`sub1.contoso.com`、`sub2.contoso.com`) を追加するか、複数のドメイン (`*.contoso.com`) を追加するかを決定します。

### <a name="to-install-root-certificates"></a>ルート証明書をインストールするには<a name="install-certs"></a>

1. 次の手順を繰り返して、 **[現在の CA]** および **[次の CA]** の自己署名ルート証明書をインストールします。
    1. 証明書を選択します。
    1. **[開く]** をクリックし、メッセージが表示されたらもう一度 **[開く]** をクリックします。
    1. **[証明書のインストール]** をクリックします。
    1. **[現在のユーザー]** または **[ローカル コンピューター]** を選択します。
    1. **[証明書をすべて次のストアに配置する]** を選択し、 **[参照]** をクリックします。
    1. **[信頼されたルート証明機関]** を選択し、 **[OK]** をクリックします。
    1. **[Finish]** をクリックします。

    > [!NOTE]
    > 証明書が認識されるようにするには、証明書をインストールした後、ブラウザーを再起動して同じページにアクセスする必要があります。<!-- You'll see a check-mark by the certificates links confirmation they are installed.-->

1. **[続行]** をクリックします。

## <a name="step-4-verify-that-the-app-is-working-correctly"></a>手順 4:アプリが正常に動作していることを確認する<a name="verify-app"></a>

1. サインイン フローが正常に動作することを確認します。
    <!--
    > [!NOTE]
    > Some apps issue a nonce hash during authentication that may break the sign-in process. If this happens, see the Troubleshooting Guide to resolve the issue.-->
1. アプリに移動したら、次のチェックを実行します。
    1. ユーザーの作業プロセスに含まれる、アプリ内のすべてのページにアクセスし、ページが正しく表示されることを確認します。
    1. ファイルのダウンロードやアップロードなどの一般的な操作を実行することにより、アプリの動作と機能が悪影響を受けないことを確認します。
    1. アプリに関連付けられているドメインの一覧を確認します。 詳細については、[アプリのドメインの追加](#add-domains)に関するセクションをご覧ください。

## <a name="step-5-enable-the-app-for-use-in-your-organization"></a>手順 5:組織でアプリを使用できるようにする<a name="enable-app"></a>

組織の運用環境でアプリを使用できるようにする準備が整ったら、次の手順を実行します。

1. Cloud App Security で、設定の歯車 ![設定アイコン](media/settings-icon.png "設定アイコン") をクリックし、 **[アプリの条件付きアクセス制御]** を選択します。
1. アプリの一覧で、展開するアプリが表示されている行の末尾の 3 つのドットを選択し、 **[アプリの編集]** を選択します。
1. **[アプリの条件付きアクセス制御で使う]** を選択して、 **[保存]** を選択します。

## <a name="step-6-update-the-azure-ad-policy-azure-ad-only"></a>手順 6:Azure AD ポリシーを更新する (Azure AD のみ)<a name="update-azure-ad"></a>

1. Azure AD の **[セキュリティ]** の下で、 **[条件付きアクセス]** をクリックします。
1. 前に作成したポリシーを更新して、関連する必要なユーザー、グループ、および制御を追加します。
1. **[セッション]**  >  **[アプリの条件付きアクセス制御を使う]** の下で **[カスタム ポリシーを使用する]** を選択した場合は、Cloud App Security に移動して、対応するセッション ポリシーを作成します。 詳しくは、「[セッション ポリシー](session-policy-aad.md)」をご覧ください。

## <a name="next-steps"></a>次のステップ

> [!div class="nextstepaction"]
> [« 前へ:おすすめアプリに対してアプリの条件付きアクセス制御を展開する](proxy-deployment-aad.md)

> [!div class="nextstepaction"]
> [次へ:セッション ポリシーを作成する方法 »](session-policy-aad.md)

## <a name="see-also"></a>関連項目

> [!div class="nextstepaction"]
> [アプリの条件付きアクセス制御の概要](proxy-intro-aad.md)

[!INCLUDE [Open support ticket](includes/support.md)]
