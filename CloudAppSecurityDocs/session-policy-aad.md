---
title: "ユーザー セッション アクティビティを詳細に可視化し、ダウンロードをブロックするためのセッション ポリシーを作成する | Microsoft Docs"
description: "このトピックでは、ユーザー セッション アクティビティを詳細に可視化し、ダウンロードをブロックするように Cloud App Security プロキシ セッション ポリシーを設定する手順について説明します。"
keywords: 
author: rkarlin
ms.author: rkarlin
manager: mbaldwin
ms.date: 10/31/2017
ms.topic: article
ms.prod: 
ms.service: cloud-app-security
ms.technology: 
ms.assetid: 745df28a-654c-4abf-9c90-203841169f90
ms.reviewer: reutam
ms.suite: ems
ms.openlocfilehash: 97ebb7db49fcf5ed524a05943557d616487294f8
ms.sourcegitcommit: 3bc510959e66a29d474cbef412deac0daefa8a24
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/31/2017
---
# <a name="session-policies"></a>セッション ポリシー 

> [!NOTE]
> Microsoft Cloud App Security プロキシ機能のロールアウトが開始されました。

Cloud App Security のセッション ポリシーを使うと、セッション レベルでのリアルタイム監視が可能になり、クラウド アプリの詳細な情報を把握し、ユーザー セッションに設定したポリシーに応じて異なるアクションを実行できます。 セッション制御では、アクセスを完全に許可またはブロックするのではなく、セッションを監視しながらアクセスを許可したり、特定のセッション アクティビティを制限したりできます。 

たとえば、デバイスが管理されていない場合やセッションが特定の場所から行われている場合に、アプリにアクセスすることをユーザーに許可しながら、機密ファイルのダウンロードを制限したり、特定のドキュメントがダウンロード時に保護されることを要求したりすることができます。 セッション ポリシーでは、このようなユーザー セッション制御を設定できます。 

## <a name="prerequisites-to-using-session-policies"></a>セッション ポリシーを使うための前提条件

- Azure AD Premium P2 のライセンス
- 関連するアプリを[プロキシと共にデプロイする](proxy-deployment-aad.md)必要があります
- 以下で説明するように、Cloud App Security プロキシにユーザーをリダイレクトする [Azure AD 条件付きアクセス ポリシー](https://docs.microsoft.com/azure/active-directory/active-directory-conditional-access-azure-portal)を設定する必要があります。


## <a name="create-an-azure-ad-conditional-access-policy"></a>Azure AD 条件付きアクセス ポリシーを作成する

Azure Active Directory の条件付きアクセス ポリシーと Cloud App Security のセッション ポリシーは連携して動作し、各ユーザー セッションを調べて、各アプリに関するポリシーの決定を行います。 Azure AD で条件付きアクセス ポリシーを設定するには、次の手順のようにします。

1. ユーザーまたはユーザー グループに対する割り当てと、Cloud App Security プロキシで制御する SAML アプリを指定して、[Azure AD 条件付きアクセス ポリシー](https://docs.microsoft.com/azure/active-directory/active-directory-conditional-access-azure-portal)を構成します。 

  > [!NOTE]
  > このポリシーが適用されるのは、[プロキシと共にデプロイ](proxy-deployment-aad.md)されたアプリだけです。

2. **[セッション]** ブレードで **[プロキシによって適用される制限を使用する]** を選んで、Cloud App Security プロキシにユーザーをルーティングします。

 ![プロキシが制限する Azure AD 条件付きアクセス](./media/proxy-deploy-restrictions-aad.png)

## <a name="create-a-cloud-app-security-session-policy"></a>Cloud App Security セッション ポリシーを作成する 

新しいセッション ポリシーを作成するには、以下の手順を実行します。

1. ポータルで、**[制御]**、**[ポリシー]** の順に選びます。
3. **[ポリシー]** ページで、**[ポリシーの作成]** をクリックし、**[セッション ポリシー]** を選びます。  

 ![セッション ポリシーを作成する](./media/create-session-policy.png)

4. **[セッション ポリシー]** ウィンドウで、ポリシーの名前を割り当てます (例: "*マーケティング ユーザー用 Box の機密ドキュメントのダウンロードをブロックする*")。

 ![新しいセッション ポリシー](./media/new-session-policy.png)

5. **[セッション制御の種類]** フィールドで次のようにします。 

    1. ユーザーによりアクティビティを監視するだけの場合は、**[すべてのアクティビティを監視する]** を選びます。

    2. ユーザーのアクティビティを監視し、ユーザーのダウンロードのブロックや保護などの追加アクションを実行する場合は、**[すべてのアクティビティを監視し、ファイルのダウンロードを制御する]** を選びます。

    ![セッション ポリシー制御の種類](./media/session-policy-control-type.png)

6. **[次のすべてに一致するアクティビティ]** セクションの **[アクティビティ ソース]** で、ポリシーに適用する追加のアクティビティ フィルターを選びます。 次のオプションを指定できます。 

     - **[デバイス タグ]**: 管理されていないデバイスを識別するには、このフィルターを使います。

     - **[場所]**: 不明な (したがって危険な) 場所を識別するには、このフィルターを使います。 

     - **[IP アドレス]**: IP アドレスでフィルター処理するか、前に割り当てた IP アドレス タグを使うには、このフィルターを使います。 

     - **[ユーザー エージェント タグ]**: モバイル アプリまたはデスクトップ アプリを識別するためにヒューリスティックを有効にするには、このフィルターを使います。 このフィルターは、**ネイティブ クライアント**と等しくなるように、または等しくならないように設定でき、各クラウド アプリについてモバイル アプリとデスクトップ アプリに対してテストする必要があります。
         
         ![ネイティブ クライアントのサポート](./media/user-agent-tag.png)

       >[!NOTE]
       >セッション ポリシーは、モバイル アプリとデスクトップ アプリをサポートしていません。 セッション ポリシーがモバイル アプリとデスクトップ アプリの機能に干渉しないことをテストして確認してください。 必要な場合は、モバイル アプリとデスクトップ アプリをセッション ポリシーから除外します。

     ![セッション ポリシーのアクティビティ ソース](./media/session-policy-activity-filters.png)

7. **[すべてのアクティビティを監視し、ファイルのダウンロードを制御する]** オプションを選んだ場合:

    1. **[次のすべてに一致するファイル]** セクションの **[アクティビティ ソース]** で、ポリシーに適用する追加のファイル フィルターを選びます。 次のオプションを指定できます。

        - **[分類ラベル]**: 組織が Azure Information Protection を使っていて、データがその分類ラベルで保護されている場合は、このフィルターを使います。 適用した分類ラベルに基づいてファイルをフィルター処理できます。 Cloud App Security と Azure Information Protection の統合について詳しくは、「[Azure Information Protection の統合](azip-integration.md)」をご覧ください。

        - **[ファイル名]**: 特定のファイルにポリシーを適用するには、このフィルターを使います。

        - **[ファイルの種類]**: 特定のファイルの種類にポリシーを適用するには、このフィルターを使います (すべての .xls ファイルのダウンロードをブロックする場合など)。

         ![セッション ポリシーのファイル フィルター](./media/session-policy-file-filters.png)

        
    2. **[コンテンツ検査]** セクションで、DLP エンジンによるドキュメントとファイルのコンテンツのスキャンを有効にするかどうかを設定します。
 
     ![セッション ポリシーのコンテンツ検査](./media/session-policy-content-inspection.png)

    3. **[アクション]** ウィンドウで、次のいずれかを選びます。 

        - **[許可]**: 設定したポリシー フィルターに従ってダウンロードを明示的に許可するには、このアクションを設定します。

        - **[ブロック]**: 設定したポリシー フィルターに従ってダウンロードを明示的にブロックするには、このアクションを設定します。 詳しくは、「[ダウンロードのブロックのしくみ](#block-download)」をご覧ください。

        - **[保護]**: 組織が Azure Information Protection を使っている場合は、Azure Information Protection で設定されている分類ラベルをファイルに適用するように **[アクション]** を設定できます。 詳しくは、「[ダウンロードの保護のしくみ](#protect-download)」をご覧ください。

         ![セッション ポリシーのアクション](./media/session-policy-actions.png)

10. **一致するイベントごとにポリシー重要度に応じたアラートを作成**し、アラート制限を設定して、アラートをメールとテキスト メッセージのどちらか一方または両方にするかどうかを選ぶことができます。

    ![セッション ポリシーのアラート](./media/session-policy-alert.png)


## <a name="how-session-monitoring-works"></a>セッション監視のしくみ

セッション ポリシーを作成すると、ポリシーに一致する各ユーザー セッションは、直接アプリにではなく、プロキシ セッション制御にリダイレクトされます。 ユーザーには、セッションが監視されていることを知らせる監視通知が表示されます。

   ![セッション監視のしくみ](./media/session-monitoring-notice.png)

監視されていることをユーザーに通知したくない場合は、通知メッセージを無効にすることができます。

1. 設定の歯車アイコンで、**[全般設定]** を選びます。 

2. 次に、Cloud App Security プロキシの設定で、**[ユーザーに通知する]** チェック ボックスをオフにします。

    ![セッション監視通知を無効にする](./media/disable-session-monitoring-notice.png)

セッション内でユーザーを保持するために、プロキシは、アプリ内の関連するすべての URL、Java スクリプト、Cookie を、プロキシの URL に置き換えます。 たとえば、ドメインが myapp.com で終わるリンクを含むページをアプリが返した場合、プロキシはそのリンクを、myapp.com.us.cas.ms などで終わるドメインに置き換えます。 これにより、セッション全体がプロキシによって監視されます。

プロキシは、ルーティングされてきたすべてのユーザー セッションのトラフィック ログを記録します。 トラフィック ログには、時刻、IP、ユーザー エージェント、アクセスした URL、アップロードおよびダウンロードされたバイト数が含まれます。 これらのログが分析されて、**Cloud App Security Proxy** という名前の継続的なレポートが、Cloud Discovery ダッシュボードの Cloud Discovery レポート一覧に追加されます。

![プロキシのレポート](./media/proxy-report.png)


ログをエクスポートするには:

1. 設定の歯車アイコンに移動し、**[プロキシ]** をクリックします。
2. テーブルの右側にあるエクスポート ボタンをクリックします ![エクスポート ボタン](./media/export-button.png)。 
3. レポートの範囲を選び、**[エクスポート]** をクリックします。 この処理には時間がかかる場合があります。

エクスポートされたログをダウンロードするには:

1. レポートの準備ができたら、**[調査]**、**[カスタム レポート]** の順に移動します。
2. テーブルで、**プロキシ トラフィック ログ**の一覧から関連するレポートを選んで、ダウンロード ![ダウンロード ボタン](./media/download-button.png) をクリックします。 


## ダウンロードのブロックのしくみ <a name="block-download"></a>

Cloud App Security プロキシのセッション ポリシーで実行する **[アクション]** として **[ブロック]** が設定されていると、プロキシはポリシーのファイル フィルターに従ってユーザーがファイルをダウンロードできないようにします。 ダウンロード イベントは各 SAML アプリのプロキシによって認識され、ユーザーがこのイベントを開始すると、プロキシはリアルタイムで介入して実行を防ぎます。 ユーザーがダウンロードを開始したことを示す信号を受け取ったプロキシは、**ダウンロードが制限されている**というメッセージをユーザーに返し、ダウンロードされるファイルを、ユーザーに対するカスタマイズ可能なメッセージを含むテキスト ファイルに置き換えます。これは、プロキシ セッション ポリシーから構成できます。  

## ダウンロードの保護のしくみ <a name="protect-download"></a>

Cloud App Security プロキシのセッション ポリシーで実行する **[アクション]** として **[保護]** が設定されていると、プロキシはポリシーのファイル フィルターに従って、ファイルのラベル付けとその後の保護を適用します。 ラベルは Azure の Azure Information Protection コンソールで構成され、Cloud App Security ポリシーのオプションとしてラベルが表示されるためには、ラベル内で **[保護]** が選ばれている必要があります。 ラベルが選ばれていて、Cloud App Security ポリシーの条件 (ラベル) に一致するファイルがダウンロードされると、アクセス許可がある対応する保護が、ダウンロード時にファイルに適用されます。 元のファイルはクラウド アプリ内にそのまま残っていますが、ダウンロードされるファイルは保護されています。 ファイルにアクセスしようとするユーザーは、適用された保護によって決定されるアクセス許可要件を満たす必要があります。  
 
  
## <a name="see-also"></a>参照  
[Azure AD のプロキシ機能を使って管理されていないデバイスでのダウンロードをブロックする](use-case-proxy-block-session-aad.md)   
[テクニカル サポートが必要な場合は、Cloud App Security のサポート ページをご利用ください。](http://support.microsoft.com/oas/default.aspx?prid=16031)   
[Premier サポートをご利用のお客様は、Premier ポータルから直接 Cloud App Security を選択することもできます。](https://premier.microsoft.com/)  
  
  