---
title: Azure AD アプリに対して Cloud App Security のアプリの条件付きアクセス制御をデプロイする
description: この記事では、Azure AD アプリに対して Microsoft Cloud App Security のアプリの条件付きアクセス制御のリバース プロキシ機能をデプロイする方法について説明します。
keywords: ''
author: shsagir
ms.author: shsagir
manager: shsagir
ms.date: 03/31/2020
ms.topic: conceptual
ms.collection: M365-security-compliance
ms.service: cloud-app-security
ms.suite: ems
ms.openlocfilehash: 9e75c101bf55dd86f4d787c9a6e3ea6500e04f1b
ms.sourcegitcommit: 97563af6076ccbad0d994ac69a85a998a625d06a
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/28/2020
ms.locfileid: "87296955"
---
# <a name="deploy-conditional-access-app-control-for-featured-apps"></a>フィーチャー アプリでの条件付きアクセス アプリ制御の展開

*適用対象:Microsoft Cloud App Security*

Microsoft Cloud App Security のセッション コントロールは、おすすめアプリと連動します。 Cloud App Security でおすすめされている、すぐに使用できるアプリの一覧については、[Cloud App Security のアプリの条件付きアクセス制御を使用したアプリの保護](proxy-intro-aad.md#featured-apps)に関する記事をご覧ください。

## <a name="prerequisites"></a>[前提条件]

- アプリの条件付きアクセス制御を使用するには、お客様の組織が次のライセンスを持っている必要があります。

  - [Azure Active Directory (Azure AD) Premium P1](https://docs.microsoft.com/azure/active-directory/license-users-groups) 以上、またはお使いの ID プロバイダー (IdP) ソリューションから要求されるライセンス
  - Microsoft Cloud App Security

- アプリはシングル サインオンを使用して構成する必要があります
- アプリで、次のいずれかの認証プロトコルを使用する必要があります。

    |IdP|プロトコル|
    |---|---|
    |Azure AD|SAML 2.0 または OpenID Connect|
    |その他|SAML 2.0|

## <a name="to-deploy-featured-apps"></a>おすすめアプリをデプロイするには

次の手順に従って、Microsoft Cloud App Security のアプリの条件付きアクセス制御で制御されるように、おすすめアプリを構成します。

**手順 1: [Cloud App Security と連動するように IdP を構成する](#conf-idp)**

**手順 2: [ポリシーにスコープ設定されたユーザーを使用して各アプリにサインインする](#sign-in-scoped)**

**手順 3: [アクセス制御とセッション制御を使用するようにアプリが構成されていることを確認する](#portal)**

**手順 4: [デプロイをテストする](#test)**

## <a name="step-1--configure-your-idp-to-work-with-cloud-app-security"></a>手順 1:Cloud App Security と連動するように IdP を構成する<a name="conf-idp"></a><a name="add-azure-ad"></a>

### <a name="configure-integration-with-azure-ad"></a>Azure AD との統合を構成する

次の手順に従って、アプリ セッションを Cloud App Security にルーティングする Azure AD 条件付きアクセス ポリシーを作成します。 その他の IdP ソリューションについては、「[その他の IdP ソリューションとの統合を構成する](#configure-integration-with-other-idp-solutions)」をご覧ください。

1. Azure AD で、 **[セキュリティ]**  >  **[条件付きアクセス]** の順に移動します。

1. **[条件付きアクセス]** ペインの上部にあるツール バーで、 **[新しいポリシー]** をクリックします。

1. **[新規]** ペインの **[名前]** テキストボックスに、ポリシー名を入力します。

1. **[割り当て]** の下で、 **[ユーザーとグループ]** をクリックし、アプリのオンボード (最初のサインオンと確認) を行うユーザーを割り当ててから、 **[完了]** をクリックします。

1. **[割り当て]** の下で、 **[クラウド アプリ]** をクリックし、アプリの条件付きアクセス制御を使用して制御するアプリを割り当ててから、 **[完了]** をクリックします。

1. **[アクセス制御]** の下で **[セッション]** をクリックし、 **[アプリの条件付きアクセス制御を使う]** を選択して、組み込みのポリシー ( **[監視のみ]** または **[ダウンロードを禁止する]** ) または **[カスタム ポリシーを使用する]** を選択し、Cloud App Security の高度なポリシーを設定します。その後、 **[選択]** をクリックします。

    ![Azure AD 条件付きアクセス](media/azure-ad-caac-policy.png)

1. 必要に応じて、条件の追加と制御の許可を行います。

1. **[ポリシーを有効にする]** を **[オン]** に設定して、 **[作成]** をクリックします。

### <a name="configure-integration-with-other-idp-solutions"></a>その他の IdP ソリューションとの統合を構成する

次の手順に従って、他の IdP ソリューションから Cloud App Security にアプリ セッションをルーティングします。 Azure AD については、「[Azure AD との統合を構成する](#configure-integration-with-azure-ad)」をご覧ください。

1. Cloud App Security で、 **[調査]**  >  **[接続アプリ]**  >  **[アプリの条件付きアクセス制御アプリ]** の順に移動します。

1. プラス記号をクリックし、ポップアップでデプロイするアプリを選択してから、 **[ウィザード起動]** をクリックします。
1. **[アプリ情報]** ページで、アプリのシングル サインオン構成のページからの情報を使用してフォームに入力し、 **[次へ]** をクリックします。
    - お使いの IdP から、選択したアプリのシングル サインオンのメタデータ ファイルが提供されている場合は、 **[アプリからのメタデータ ファイルをアップロードする]** を選択してメタデータ ファイルをアップロードします。
    - または、 **[データを手動で入力する]** を選択して、次の情報を指定します。
        - **Assertion Consumer Service URL**
        - アプリで SAML 証明書が提供されている場合は、 **[<アプリ名> の SAML 証明書を使用する]** を選択して、証明書ファイルをアップロードします。

    ![アプリ情報ページを示すスクリーンショット](media/proxy-deploy-add-idp-app-info.png)

1. **[ID プロバイダー]** ページで、表示されている手順に従って IdP のポータルで新しいアプリケーションを設定した後、 **[次へ]** をクリックします。
    1. IdP のポータルに移動して、新しいカスタム SAML アプリを作成します。
    1. 既存の `<app_name>` アプリのシングル サインオン構成を、新しいカスタム アプリにコピーします。
    1. 新しいカスタム アプリにユーザーを割り当てます。
    1. アプリのシングル サインオン構成の情報をコピーします。次の手順で必要になります。

    ![ID プロバイダーの情報を収集するページを示すスクリーンショット](media/proxy-deploy-add-idp-get-conf.png)

    > [!NOTE]
    > これらの手順は、使用する ID プロバイダーによって多少異なる場合があります。 この手順は、次の理由で推奨されます。
    >
    > - 一部の ID プロバイダーでは、ギャラリー アプリの SAML 属性や URL プロパティを変更できません
    > - カスタム アプリを構成すると、組織の既存の動作を変更することなく、アクセス制御とセッション制御を使用してこのアプリケーションをテストできます。

1. 次のページで、アプリのシングル サインオン構成のページからの情報を使用してフォームに入力し、 **[次へ]** をクリックします。
    - お使いの IdP から、選択したアプリのシングル サインオンのメタデータ ファイルが提供されている場合は、 **[アプリからのメタデータ ファイルをアップロードする]** を選択してメタデータ ファイルをアップロードします。
    - または、 **[データを手動で入力する]** を選択して、次の情報を指定します。
        - **Assertion Consumer Service URL**
        - アプリで SAML 証明書が提供されている場合は、 **[<アプリ名> の SAML 証明書を使用する]** を選択して、証明書ファイルをアップロードします。

    ![ID プロバイダーの情報を入力するページを示すスクリーンショット](media/proxy-deploy-add-idp-enter-conf.png)

1. 次のページで、以下の情報をコピーしてから、 **[次へ]** をクリックします。 次の手順でこの情報が必要になります。

    - シングル サインオンの URL
    - 属性と値

    ![ID プロバイダーの SAML 情報を収集するページを示すスクリーンショット](media/proxy-deploy-add-idp-ext-conf.png)

1. IdP のポータルで、次の操作を行います。
    > [!NOTE]
    > この設定は、IdP ポータルのカスタム アプリの設定ページによくあります

    1. シングル サインオンの URL フィールドに、前にメモしておいたシングル サインオンの URL を入力します。
        > [!NOTE]
        > プロバイダーによっては、シングル サインオンの URL が "*応答 URL*" として参照される場合があります。
    1. 前にメモしておいた属性と値を、アプリのプロパティに追加します。
        > [!NOTE]
        >
        > - プロバイダーによっては、これらが "*ユーザー属性*" または "*要求*" として参照される場合があります。
        > - 新しい SAML アプリを作成する場合、Okta ID プロバイダーでは属性が 1024 文字に制限されます。 この制限を緩和するには、まず、関連する属性なしでアプリを作成します。 アプリの作成後に編集して、関連する属性を追加します。
    1. 名前識別子がメール アドレスの形式であることを確認します。
    1. 設定を保存します。
1. **[アプリの変更]** ページで、次の操作を行って、 **[次へ]** をクリックします。 次の手順でこの情報が必要になります。

    - シングル サインオンの URL をコピーします
    - Cloud App Security の SAML 証明書をダウンロードします

    ![Cloud App Security の SAML 情報を収集するページを示すスクリーンショット](media/proxy-deploy-add-idp-app-changes.png)

1. アプリのポータルの、シングル サインオンの設定で、次の操作を行います。
    1. [推奨] 現在の設定のバックアップを作成します。
    1. シングル サインオンの URL フィールドに、前にメモしておいたシングル サインオンの URL を入力します。
    1. 前にメモしておいた Cloud App Security の SAML 証明書をアップロードします。
    > [!NOTE]
    > 設定を保存すると、このアプリに関連付けられたすべてのログイン要求が、アプリの条件付きアクセス制御経由でルーティングされます。

## <a name="step-2-sign-in-to-each-app-using-a-user-scoped-to-the-policy"></a>手順 2:ポリシーにスコープ設定されたユーザーを使用して各アプリにサインインする<a name="sign-in-scoped"></a>

> [!NOTE]
> 続行する前に、まず既存のセッションからサインアウトしてください。

ポリシーを作成したら、そのポリシーで構成されている各アプリにサインインします。 必ずポリシーで構成されているユーザーを使用してサインインします。

Cloud App Security によって、サインインする新しいアプリごとに、ポリシーの詳細がそのサーバーに同期されます。 これには最大 1 分かかることがあります。

## <a name="step-3-verify-the-apps-are-configured-to-use-access-and-session-controls"></a>手順 3:アクセス制御とセッション制御を使用するようにアプリが構成されていることを確認する<a name="portal"></a>

上記の手順を使用すると、おすすめアプリ用の組み込みの Cloud App Security ポリシーを、Azure AD で直接作成できます。 この手順では、これらのアプリに対してアクセス制御とセッション制御が構成されていることを確認します。

1. Cloud App Security ポータルで、設定の歯車 ![設定アイコン](media/settings-icon.png "設定アイコン") をクリックし、 **[アプリの条件付きアクセス制御]** を選択します。

1. [アプリの条件付きアクセス制御アプリ] の表で、 **[利用可能な制御]** 列を確認し、アプリに対して **[アクセス制御]** または **[Azure AD 条件付きアクセス]** と **[セッション制御]** の両方が表示されていることを確認します。

    > [!NOTE]
    > アプリに対してセッション制御が表示されない場合は、その特定のアプリではまだ使用できません。 それを[カスタム アプリ](proxy-deployment-any-app.md)としてすぐに追加するか、 **[要求セッション制御]** をクリックして、おすすめアプリとして追加する要求を作成することができます。
    >
    >![条件付きアクセスのアプリ制御の要求](media/caac-request.png)

## <a name="step-4-test-the-deployment"></a>手順 4:デプロイをテストする<a name="test"></a>

1. まず、既存のセッションからサインアウトします。 次に、正常にデプロイされた各アプリにサインインしてみます。 Azure AD で構成されたポリシーに一致するユーザー、または SAML アプリの場合は ID プロバイダーで構成されたユーザーを使用してサインインします。

1. Cloud App Security ポータルの **[調査]** で、 **[アクティビティ ログ]** を選択し、各アプリのログイン アクティビティがキャプチャされていることを確認します。

1. フィルター処理を行うには、 **[詳細設定]** をクリックし、 **[Source equals Access control]\(ソースがアクセス制御と等しい\)** を使用してフィルター処理を行います。

    ![Azure AD 条件付きアクセスを使用したフィルター処理](media/sso-logon.png)

1. マネージド デバイスとアンマネージド デバイスからモバイル アプリおよびデスクトップ アプリにサインインすることをお勧めします。 これは、アクティビティが適切にアクティビティ ログにキャプチャされるようにするためです。  
アクティビティが適切にキャプチャされていることを確認するには、シングル サインオンのログイン アクティビティをクリックして、アクティビティ ドロワーを開きます。 デバイスがネイティブ クライアント (モバイル アプリまたはデスクトップ アプリ) であるか、またはデバイスがマネージド デバイス (準拠、ドメイン参加、または有効なクライアント証明書) であるかが、 **[ユーザー エージェント タグ]** に適切に反映されていることを確認します。

> [!NOTE]
> デプロイした後は、[アプリの条件付きアクセス制御] ページからアプリを削除することはできません。 アプリに対してセッションまたはアクセス ポリシーを設定しない限り、アプリの条件付きアクセス制御によってアプリの動作が変更されることはありません。

## <a name="next-steps"></a>次のステップ

> [!div class="nextstepaction"]
> [« 前へ:アプリの条件付きアクセス制御の概要](proxy-intro-aad.md)

> [!div class="nextstepaction"]
> [次へ:任意のアプリに対するアプリの条件付きアクセス制御のオンボードとデプロイ »](proxy-deployment-any-app.md)

> [!div class="nextstepaction"]
> [アクセスおよびセッション制御のトラブルシューティング](troubleshooting-proxy.md)

[!INCLUDE [Open support ticket](includes/support.md)]
